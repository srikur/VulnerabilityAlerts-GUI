//
//  ViewController.m
//  VulnerabilityAlerts-GUI
//
//  Created by Srikur Kanuparthy on 12/19/19.
//  Copyright Â© 2019 Srikur Kanuparthy. All rights reserved.
//

#import "ViewController.h"

@implementation ViewController

- (void)viewDidLoad {
    [super viewDidLoad];

    // Simulate pressing the refresh button to load the list initially
    [self setupScrollView];
    [self setupTableView];
    [self initialLoad];
}

- (void)setRepresentedObject:(id)representedObject {
    [super setRepresentedObject:representedObject];

    // Update the view, if already loaded.
}

- (void) initialLoad {
    // Do initial loading
}

- (IBAction)refreshButtonClicked:(NSButton *)sender {
    // Refresh button clicked
    [self updateScrollView:@"Loading vulnerability list!\n" withColor:[NSColor blueColor]];
    
    // Call graphQLPost() to send the request
    NSData* result = [self graphQLPost];
    
    // Process the JSON Data
    [self parseJSON:result];
}

- (void) updateScrollView:(NSString*) dataToWrite withColor:(NSColor*)color{
    // Log the string and output it to the scrollView
    //NSLog(@"%@", dataToWrite);
    [_outputLogScrollView.documentView setTextColor:color];
    [_outputLogScrollView.documentView insertText:dataToWrite];
}

- (void) parseJSON: (NSData*) resultContent{
    // Parse the output text
    NSError* parsingError;
    id serializedObject = [NSJSONSerialization JSONObjectWithData:resultContent options:0 error:&parsingError];
    if(parsingError){
        [self updateScrollView:@"There was a problem parsing the JSON data!\n\n" withColor:[NSColor blueColor]];
    }
    if([serializedObject isKindOfClass:[NSDictionary class]]){
        [self updateScrollView:@"The parsed JSON object is of type NSDictionary\n\n" withColor:[NSColor greenColor]];
    } else if ([serializedObject isKindOfClass:[NSArray class]]){
        [self updateScrollView:@"The parsed JSON object is of type NSArray\n\n" withColor:[NSColor greenColor]];
    } else {
        [self updateScrollView:@"Welp...\n\n" withColor:[NSColor greenColor]];
    }
    
    // The results are in an NSDictionary
    NSDictionary* repositories = [serializedObject valueForKeyPath:@"data.viewer.repositories"];
    int repositoryCount = [[repositories valueForKey:@"totalCount"] intValue];
    [self updateScrollView:[NSString stringWithFormat:@"%d", repositoryCount] withColor:[NSColor blueColor]];
    NSArray* repos = [serializedObject valueForKeyPath:@"data.viewer.repositories.nodes"];
    
    //Go through the repositories and set the properties in the Vulnerability class
    /*Vulnerability* vuln = [[Vulnerability alloc] init];
    for (NSDictionary* object in repos) {
        
        [vuln setValue:[NSString stringWithFormat:@"%@",[object valueForKey:@"nameWithOwner"]] forKey:@"repository"];
        
        
        [self updateScrollView:[NSString stringWithFormat:@"nameWithOwner: %@\n", [object valueForKey:@"nameWithOwner"]] withColor:[NSColor systemPinkColor]];
        [self updateScrollView:[NSString stringWithFormat:@"id: %@\n", [object valueForKeyPath:@"vulnerabilityAlerts.nodes.id"]] withColor:[NSColor systemPinkColor]];
        [self updateScrollView:[NSString stringWithFormat:@"Description: %@\n\n", [object valueForKeyPath:@"vulnerabilityAlerts.nodes.securityAdvisory.description"]] withColor:[NSColor systemPinkColor]];
        [self updateScrollView:[NSString stringWithFormat:@"Severity: %@\n\n", [object valueForKeyPath:@"vulnerabilityAlerts.nodes.securityAdvisory.severity"]] withColor:[NSColor systemPinkColor]];
        [self updateScrollView:[NSString stringWithFormat:@"Origin: %@\n\n", [object valueForKeyPath:@"vulnerabilityAlerts.nodes.securityAdvisory.origin"]] withColor:[NSColor systemPinkColor]];
    }*/
}

- (NSData*) graphQLPost{
    
    // Parse the JSON GraphQL query
    NSString* filePath = [[NSBundle mainBundle] pathForResource:@"graphql" ofType:@"query"];
    [self updateScrollView:[NSString stringWithFormat:@"GraphQL Query File Path: %@\n\n", filePath] withColor:[NSColor whiteColor]];
    NSString* jsonString = [[NSString alloc] initWithContentsOfFile:filePath encoding:NSUTF8StringEncoding error:nil];
    NSData* jsonData = [jsonString dataUsingEncoding:NSUTF8StringEncoding];
    
    // Post request to Github to execute the GraphQL query
    NSString* graphQLQuery = [[NSString alloc] initWithData:jsonData encoding:NSUTF8StringEncoding];
    [self updateScrollView:[NSString stringWithFormat:@"Value of graphQLQuery: %@\n\n", graphQLQuery] withColor:[NSColor whiteColor]];
    graphQLQuery = [[graphQLQuery componentsSeparatedByCharactersInSet:[NSCharacterSet newlineCharacterSet]] componentsJoinedByString:@" "];
    
    // Need to add 'query' to the graphql query for it to work
    NSString* prefix = @"{\"query\":\"";
    graphQLQuery = [prefix stringByAppendingString:[NSString stringWithFormat:@"%@\"}", graphQLQuery]];
    [self updateScrollView:[NSString stringWithFormat:@"New graphQLQuery: %@\n\n", graphQLQuery] withColor:[NSColor whiteColor]];
    
    NSData* graphQLPostData = [graphQLQuery dataUsingEncoding:NSUTF8StringEncoding allowLossyConversion:YES];
    NSURL* graphQLURL = [NSURL URLWithString:@"https://github.atriacom.com/api/graphql"];
    NSMutableURLRequest* graphQLRequest = [NSMutableURLRequest requestWithURL:graphQLURL];
    [graphQLRequest setHTTPMethod:@"POST"];
    [graphQLRequest addValue:@"bearer b9718d22f90409e5bfc23f2d1298ad9a07badfb4" forHTTPHeaderField:@"Authorization"];
    [graphQLRequest addValue:@"application/vnd.github.vixen-preview+json" forHTTPHeaderField:@"Accept"];
    [graphQLRequest setHTTPBody:graphQLPostData];
    
    // Send the POST request and get the return data
    NSData* graphQLResult = [NSURLConnection sendSynchronousRequest:graphQLRequest returningResponse:NULL error:NULL];
    NSString* resultantDataString = [[NSString alloc] initWithData:graphQLResult encoding:NSUTF8StringEncoding];
    [self updateScrollView:[NSString stringWithFormat:@"Resultant Data: %@\n\n", resultantDataString] withColor:[NSColor whiteColor]];
    
    return graphQLResult;
}

- (void) setupScrollView {
    //setup scroll view
    NSTextView* scrollViewTextView =[[NSTextView alloc] initWithFrame:NSMakeRect(0, 0,
                [_outputLogScrollView contentSize].width, [_outputLogScrollView contentSize].height)];
    [scrollViewTextView setMinSize:NSMakeSize(0.0, [_outputLogScrollView contentSize].height)];
    [scrollViewTextView setMaxSize:NSMakeSize(FLT_MAX, FLT_MAX)];
    [scrollViewTextView setVerticallyResizable:YES];
    [scrollViewTextView setHorizontallyResizable:YES];
    [scrollViewTextView setAutoresizingMask:NSViewWidthSizable];
     
    [[scrollViewTextView textContainer]
                setContainerSize:NSMakeSize([_outputLogScrollView contentSize].width, FLT_MAX)];
    [[scrollViewTextView textContainer] setWidthTracksTextView:YES];
    
    // *Assembling the Pieces* portion on the Apple documentation
    [_outputLogScrollView setDocumentView:scrollViewTextView];
    [[scrollViewTextView enclosingScrollView] setHasHorizontalScroller:YES];
    [scrollViewTextView setHorizontallyResizable:YES];
    [scrollViewTextView setAutoresizingMask:(NSViewWidthSizable | NSViewHeightSizable)];
    [[scrollViewTextView textContainer] setContainerSize:NSMakeSize(FLT_MAX, FLT_MAX)];
    [[scrollViewTextView textContainer] setWidthTracksTextView:NO];
}

- (void)setupTableView{

    NSTableColumn* description = [[NSTableColumn alloc] initWithIdentifier:@"Repository"];
    NSTableColumn* severity = [[NSTableColumn alloc] initWithIdentifier:@"Repository"];
    NSTableColumn* origin = [[NSTableColumn alloc] initWithIdentifier:@"Repository"];

    [_tableViewController addTableColumn:description];
    [_tableViewController addTableColumn:severity];
    [_tableViewController addTableColumn:origin];
    
    [_tableViewController.tableColumns[0] setTitle:@"Repository"];
    [_tableViewController.tableColumns[1] setTitle:@"ID"];
    [_tableViewController.tableColumns[2] setTitle:@"Description"];
    [_tableViewController.tableColumns[3] setTitle:@"Severity"];
    [_tableViewController.tableColumns[4] setTitle:@"Origin"];
    
    [_tableViewController sizeToFit];
}

@end
